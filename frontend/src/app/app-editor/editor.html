<canvas #canvas class="three-canvas"></canvas>
<!-- Material Stepper UI -->
<mat-horizontal-stepper
  *ngIf="editorStep"
  #stepper
  [linear]="true"
  (selectionChange)="onStepperSelectionChange($event)">

  <mat-step
    [completed]="step1Completed"
    [editable]="step1Completed"
    [optional]="false">
    <ng-template matStepLabel>Draw Rooms</ng-template>
    <div></div>
    <button mat-button (click)="onNextFromStep1()">Next</button>
  </mat-step>

  <mat-step
    [completed]="step2Completed"
    [editable]="step2Completed"
    [optional]="false">
    <ng-template matStepLabel>Walls & Features</ng-template>
    <div></div>
    <button mat-button (click)="onBackToStep1()">Back</button>
    <button mat-button (click)="onNextFromStep2()">Next</button>
  </mat-step>

  <mat-step [optional]="false">
    <ng-template matStepLabel>Furnishing</ng-template>
    <div></div>
    <button mat-button (click)="onBackToStep2()">Back</button>
  </mat-step>

</mat-horizontal-stepper>

<!-- Right-side expandable panel for steps 2 & 3 -->
<div class="editor-action-panel" [class.expanded]="actionPanelExpanded">
	<button class="expand-collapse-button" [class.expanded]="actionPanelExpanded"
		(click)="actionPanelExpanded = !actionPanelExpanded">
		<mat-icon svgIcon="chevron" class="nav-icon" aria-hidden="true"></mat-icon>
	</button>

	<div class="editor-action-buttons" *ngIf="userType === 'architect'">
		<button mat-button color="accent" (click)="saveProjectToServer()" class="full-width save-project-button">
			<span>Save project</span>
			<mat-icon svgIcon="save" class="nav-icon" aria-hidden="true"></mat-icon>
		</button>
		<button mat-button color="accent" (click)="exitEditor()" class="full-width close-editor-button">
			<span>Close editor</span>
			<mat-icon svgIcon="close" class="nav-icon" aria-hidden="true"></mat-icon>
		</button>
	</div>

	<div class="editor-action-metadata">
		<h2 class="metadata-title">Rooms</h2>
		<div *ngFor="let room of roomMetadata; let i = index" class="room-metadata-summary"
			[class.selected]="i === selectedRoomIndex">
			<p class="room-name" [style.color]="room.color | numberToColor">{{ room.name || 'Room ' + (i+1) }}</p>
			<p class="room-type">{{ room.type || 'Type: N/A' }}</p>
			<p class="room-area">Area: {{ room.area | number:'1.2-2' }} mÂ²</p>
		</div>
	</div>

	<!-- Step 2: Walls & Features -->
	<ng-container *ngIf="editorStep === 2">
		<table mat-table [dataSource]="wallFeatureRows" multiTemplateDataRows class="expandable-table">

			<!-- Label Column -->
			<ng-container matColumnDef="label">
				<td mat-cell *matCellDef="let row" (click)="row.expanded = !row.expanded">
					<mat-icon>{{ row.expanded ? 'expand_less' : 'expand_more' }}</mat-icon>
					{{ row.label }}
				</td>
			</ng-container>

			<!-- Expanded Content Column -->
			<ng-container matColumnDef="expandedDetail">
				<td mat-cell *matCellDef="let row" [attr.colspan]="1">
					<div class="expandable-content" [class.expanded]="row.expanded">
						<ng-container *ngIf="row.expanded">
							<!-- Wall Features -->
							<ng-container *ngIf="row.type === 'features'">
								<button mat-flat-button color="primary" (click)="startPlacingFeature('window')"
									[disabled]="editorStateService.placingFeatureType !== null">
									<span>Place Window</span>
									<mat-icon svgIcon="window" class="nav-icon" aria-hidden="true"></mat-icon>
								</button>
								<button mat-flat-button color="accent" (click)="startPlacingFeature('door')"
									[disabled]="editorStateService.placingFeatureType !== null">
									<span>Place Door</span>
									<mat-icon svgIcon="door" class="nav-icon" aria-hidden="true"></mat-icon>
								</button>
								<span *ngIf="editorStateService.placingFeatureType"
									style="margin-left:12px;color:#1976d2;font-weight:bold;">
									Click a wall to place a {{ editorStateService.placingFeatureType }}
								</span>
							</ng-container>

							<!-- Wall Color -->
							<ng-container *ngIf="row.type === 'wcolor'">
								<label>Wall Color:</label>
								<app-color-picker [value]="wallColor" (valueChange)="onWallColorPicked($event)">
								</app-color-picker>
							</ng-container>

							<!-- Wall Texture -->
							<ng-container *ngIf="row.type === 'wtexture'">
								<label>Wall Texture:</label>
								<select [(ngModel)]="wallTexture" (change)="applyWallTexture()">
									<option value="">None</option>
									<option value="wallpaper_1">Wallpaper 1</option>
									<option value="wallpaper_2">Wallpaper 2</option>
								</select>
							</ng-container>

							<!-- Floor Color -->
							<ng-container *ngIf="row.type === 'fcolor'">
								<label>Floor Color:</label>
								<app-color-picker [value]="floorColor" (valueChange)="onFloorColorPicked($event)">
								</app-color-picker>
							</ng-container>

							<!-- Floor Texture -->
							<ng-container *ngIf="row.type === 'ftexture'">
								<label>Floor Texture:</label>
								<select [(ngModel)]="floorTexture" (change)="applyFloorTexture()">
									<option value="">None</option>
									<option value="floor_1">Floor 1</option>
									<option value="floor_2">Floor 2</option>
								</select>
							</ng-container>
						</ng-container>
					</div>
				</td>
			</ng-container>

			<!-- Remove header row entirely -->
			<!-- No mat-header-row / matHeaderRowDef -->

			<!-- Main label rows -->
			<tr mat-row *matRowDef="let row; columns: ['label'];" [class.expanded-header-row]="row.expanded"></tr>

			<!-- Detail rows: render ONLY when row.expanded -->
			<tr mat-row *matRowDef="let row; columns: ['expandedDetail'];" [class.expanded-row]="row.expanded"
				[style.display]="row.expanded ? '' : 'none'"></tr>
		</table>
	</ng-container>

	<!-- Step 3: Furnishing -->
	<ng-container *ngIf="editorStep === 3">
		<div class="furniture-assets-gallery">
			<div *ngFor="let asset of furnitureAssets" class="furniture-asset-item"
				(click)="startPlacingFurniture(asset)">
				<app-furniture-preview [asset]="asset"></app-furniture-preview>
				<p>{{ asset.name }}</p>
			</div>
		</div>
	</ng-container>
</div>

<!-- Add feedback mode banner at the top of the editor -->
<div class="feedback-mode-banner" *ngIf="feedbackMode">
  <mat-icon>feedback</mat-icon>
  <span>Feedback Mode: Click on any element (room, wall, or furniture) to leave feedback</span>
</div>

<div class="view-only-banner" *ngIf="viewOnly && !feedbackMode">
  <mat-icon>visibility</mat-icon>
  <span>View Only Mode: You can view but not edit this project</span>
</div>

<!-- Wrap action buttons with canEdit check -->
<div class="action-panel" *ngIf="actionPanelExpanded && canEdit">
  <!-- ...existing action panel content... -->
</div>

<!-- Hide stepper navigation buttons if view-only -->
<div class="step-actions" *ngIf="canEdit">
  <!-- Step 1 actions -->
  <ng-container *ngIf="editorStep === 1">
    <button mat-raised-button color="primary" (click)="onNextFromStep1()">
      Next: Wall Features
    </button>
  </ng-container>

  <!-- Step 2 actions -->
  <ng-container *ngIf="editorStep === 2">
    <button mat-button (click)="onBackToStep1()">Back</button>
    <button mat-raised-button color="primary" (click)="onNextFromStep2()">
      Next: Furnishing
    </button>
  </ng-container>

  <!-- Step 3 actions -->
  <ng-container *ngIf="editorStep === 3">
    <button mat-button (click)="onBackToStep2()">Back</button>
  </ng-container>
</div>

<!-- Hide furniture placement panel if not canPlaceFurniture -->
<div class="furniture-panel" *ngIf="editorStep === 3 && canPlaceFurniture">
  <!-- ...existing furniture panel content... -->
</div>

<!-- Show furniture gallery as view-only if in feedback/view mode -->
<div class="furniture-panel view-only" *ngIf="editorStep === 3 && !canPlaceFurniture">
  <h4>Furniture (View Only)</h4>
  <!-- Display furniture list without click actions -->
</div>

<!-- Hide save button if view-only -->
<button mat-fab color="primary" class="save-btn" 
        *ngIf="canEdit" 
        (click)="saveProjectToServer()" 
        matTooltip="Save Project">
  <mat-icon>save</mat-icon>
</button>